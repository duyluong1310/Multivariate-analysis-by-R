name: Render Rmd to docs (branch deploy)

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  render:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - uses: actions/checkout@v4
        with:
          persist-credentials: true

      - uses: r-lib/actions/setup-r@v2
        with:
          use-public-rspm: true

      - uses: r-lib/actions/setup-pandoc@v2

      - name: Install R packages
        run: |
          Rscript -e 'install.packages(c(
            "rmarkdown","knitr","prettydoc",
            "MASS","FactoMineR","factoextra",
            "nnet","e1071",
            "tidymodels","ranger"
          ))'

      - name: Ensure docs/ + theme
        shell: bash
        run: |
          mkdir -p docs
          if [ ! -f docs/_config.yml ]; then
            cat > docs/_config.yml <<'YAML'
          title: Multivariate Analysis by R
          description: Showcase of multivariate methods generated from R notebooks
          remote_theme: pages-themes/cayman@v0.2.0
          plugins:
            - jekyll-remote-theme
          markdown: kramdown
          YAML
          fi

      - name: Render ALL .Rmd at repo root into docs/
        run: |
          Rscript -e '
            rmds <- list.files(".", pattern = "\\\\.[Rr]md$", full.names = TRUE)
            if (length(rmds) == 0) stop("No .Rmd files found in repo root")
            dir.create("docs", showWarnings = FALSE)
            for (f in rmds) {
              out <- file.path("docs", paste0(tools::file_path_sans_ext(basename(f)), ".html"))
              message("Rendering: ", f, " -> ", out)
              rmarkdown::render(
                f,
                output_format = "prettydoc::html_pretty",
                output_file   = out,
                envir = new.env()
              )
            }
          '

      - name: Auto-generate docs/index.md (menu)
        run: |
          Rscript -e '
            htmls <- list.files("docs", pattern="\\.html$", full.names=FALSE)
            if (length(htmls) == 0) quit(status=0)
            titleize <- function(x) tools::toTitleCase(gsub("_", " ", tools::file_path_sans_ext(x)))
            con <- file("docs/index.md", "w")
            writeLines(c(
              "---","layout: default","---",
              "# Multivariate Analysis by R",
              "",
              "Welcome to the showcase. Click a method below:",
              ""
            ), con)
            writeLines("## Methods", con)
            for (f in sort(htmls)) writeLines(paste0("- [", titleize(f), "](", f, ")"), con)
            close(con)
          '

      - name: Commit docs/ (force-add in case of .gitignore)
        run: |
          git config user.name "${{ github.actor }}"
          git config user.email "${{ github.actor }}@users.noreply.github.com"
          git add -f docs
          git diff --cached --quiet || git commit -m "Update docs (render Rmd)"
          git push
